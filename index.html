<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Selector</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .upload-section h2 {
            margin-top: 0;
            color: #3498db;
        }

        .file-input-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .file-input-container label {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .file-input-container label:hover {
            background-color: #2980b9;
        }

        input[type="file"] {
            display: none;
        }

        .file-name {
            font-size: 14px;
            color: #7f8c8d;
        }

        .control-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
            min-width: 200px;
        }

        button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #27ae60;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #3498db;
            color: white;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .result-section {
            text-align: center;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .chosen-book {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0;
            font-family: 'Georgia', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .pagination button {
            margin: 0 5px;
            background-color: #3498db;
        }

        .pagination button.active {
            background-color: #2c3e50;
        }

        .info-text {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Book Selector</h1>

    <div class="upload-section">
        <h2>Upload Your Book List</h2>
        <div class="file-input-container">
            <label for="fileInput">Choose CSV or Excel File</label>
            <input type="file" id="fileInput" accept=".csv, .xlsx, .xls">
            <span class="file-name" id="fileName">No file selected</span>
        </div>
        <p class="info-text">Default list is loaded automatically, or upload your own CSV/Excel file with TITLE and GENRE columns.</p>
    </div>

    <div class="control-section">
        <label for="genreSelect">Genre choice:</label>
        <select id="genreSelect">
            <option value="all">All Genres</option>
        </select>
        <button id="chooseBookBtn" disabled>Choose a book!</button>
    </div>

    <div id="tableContainer">
        <div id="loadingIndicator">
            <span class="loading"></span> Loading books...
        </div>
        <table id="booksTable" class="hidden">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Genre</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
        <p id="tableInfo" class="info-text"></p>
    </div>

    <div class="result-section hidden" id="resultSection">
        <h2>Your Random Book Selection</h2>
        <div class="chosen-book" id="chosenBook"></div>
        <p>Enjoy your reading adventure!</p>
    </div>

    <script>
        // Global variables
        let booksData = [];
        let filteredBooks = [];
        const itemsPerPage = 10;
        let currentPage = 1;

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const genreSelect = document.getElementById('genreSelect');
        const chooseBookBtn = document.getElementById('chooseBookBtn');
        const booksTable = document.getElementById('booksTable');
        const tableBody = document.getElementById('tableBody');
        const resultSection = document.getElementById('resultSection');
        const chosenBook = document.getElementById('chosenBook');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const pagination = document.getElementById('pagination');
        const tableInfo = document.getElementById('tableInfo');

        // Function to load CSV from URL
        async function loadDefaultCSV() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/Connor-Sebastian-S/new-book-decision/refs/heads/main/books.csv');
                const data = await response.text();
                processCSV(data);
            } catch (error) {
                console.error('Error loading default CSV:', error);
                alert('Failed to load the default book list. Please try uploading your own file.');
            }
        }

        // Process CSV data
        function processCSV(data) {
            const lines = data.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim());

            // Validate that required columns exist
            const titleIndex = headers.findIndex(h => h.toUpperCase() === 'TITLE');
            const genreIndex = headers.findIndex(h => h.toUpperCase() === 'GENRE');

            if (titleIndex === -1 || genreIndex === -1) {
                alert('CSV file must contain TITLE and GENRE columns');
                return;
            }

            booksData = [];
            // Start from index 1 to skip header row
            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].split(',');

                // Skip empty lines
                if (currentLine.length <= 1) continue;

                const title = currentLine[titleIndex].trim().replace(/^"|"$/g, '');
                const genre = currentLine[genreIndex].trim().replace(/^"|"$/g, '');

                if (title && genre) {
                    booksData.push({ title, genre });
                }
            }

            populateGenreDropdown();
            filterBooks();
            booksTable.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
        }

        // Process Excel files
        function processExcel(data) {
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);

            // Validate that required columns exist
            if (!jsonData.length || !jsonData[0].hasOwnProperty('TITLE') || !jsonData[0].hasOwnProperty('GENRE')) {
                alert('Excel file must contain TITLE and GENRE columns');
                return;
            }

            booksData = jsonData.map(row => ({
                title: row.TITLE.trim(),
                genre: row.GENRE.trim()
            }));

            populateGenreDropdown();
            filterBooks();
            booksTable.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
        }

        // Populate genre dropdown
        function populateGenreDropdown() {
            // Clear existing options except "All Genres"
            while (genreSelect.options.length > 1) {
                genreSelect.remove(1);
            }

            // Get unique genres
            const genres = [...new Set(booksData.map(book => book.genre))].sort();

            // Add genre options
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreSelect.appendChild(option);
            });

            // Enable choose button if we have data
            chooseBookBtn.disabled = booksData.length === 0;
        }

        // Filter books by selected genre
        function filterBooks() {
            const selectedGenre = genreSelect.value;

            if (selectedGenre === 'all') {
                filteredBooks = [...booksData];
            } else {
                filteredBooks = booksData.filter(book => book.genre === selectedGenre);
            }

            currentPage = 1;
            displayBooks();
            updatePagination();

            // Update info text
            tableInfo.textContent = `Showing ${filteredBooks.length} books${selectedGenre !== 'all' ? ` in the "${selectedGenre}" genre` : ''} out of ${booksData.length} total books`;
        }

        // Display books in table
        function displayBooks() {
            // Clear existing rows
            tableBody.innerHTML = '';

            // Calculate start and end indices for current page
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredBooks.length);

            // Create table rows
            for (let i = startIndex; i < endIndex; i++) {
                const book = filteredBooks[i];
                const row = document.createElement('tr');

                const titleCell = document.createElement('td');
                titleCell.textContent = book.title;
                row.appendChild(titleCell);

                const genreCell = document.createElement('td');
                genreCell.textContent = book.genre;
                row.appendChild(genreCell);

                tableBody.appendChild(row);
            }
        }

        // Update pagination controls
        function updatePagination() {
            pagination.innerHTML = '';

            const totalPages = Math.ceil(filteredBooks.length / itemsPerPage);

            if (totalPages <= 1) {
                return;
            }

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '←';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayBooks();
                    updatePagination();
                }
            });
            pagination.appendChild(prevBtn);

            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust startPage if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    displayBooks();
                    updatePagination();
                });
                pagination.appendChild(pageBtn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '→';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayBooks();
                    updatePagination();
                }
            });
            pagination.appendChild(nextBtn);
        }

        // Choose a random book
        function chooseRandomBook() {
            if (filteredBooks.length === 0) {
                alert('No books available in the selected genre');
                return;
            }

            const randomIndex = Math.floor(Math.random() * filteredBooks.length);
            const randomBook = filteredBooks[randomIndex];

            chosenBook.textContent = randomBook.title;
            resultSection.classList.remove('hidden');

            // Scroll to result section
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Event Listeners
        fileInput.addEventListener('change', (e) => {
            if (!e.target.files.length) return;

            const file = e.target.files[0];
            fileName.textContent = file.name;

            // Show loading indicator
            booksTable.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            resultSection.classList.add('hidden');

            // Process file based on type
            const reader = new FileReader();

            if (file.name.endsWith('.csv')) {
                reader.onload = (e) => {
                    processCSV(e.target.result);
                };
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = (e) => {
                    processExcel(e.target.result);
                };
                reader.readAsBinaryString(file);
            } else {
                alert('Please upload a CSV or Excel file');
                loadingIndicator.classList.add('hidden');
            }
        });

        genreSelect.addEventListener('change', filterBooks);
        chooseBookBtn.addEventListener('click', chooseRandomBook);

        // Load SheetJS for Excel parsing (CDN)
        function loadExcelScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize
        async function init() {
            try {
                await loadExcelScript();
                await loadDefaultCSV();
            } catch (error) {
                console.error('Initialization error:', error);
                loadingIndicator.textContent = 'Failed to initialize. Please refresh the page or try uploading your own file.';
            }
        }

        init();
    </script>
</body>
</html>
