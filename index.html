<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alegreya:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <title>New Book Purchase Decision Maker</title>
    <style>
        /* Base styles */
body {
            font-family: 'Alegreya', serif;
            font-weight: 400; /* Regular weight */
            line-height: 1.6;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            transition: background-image 0.5s ease-in-out;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        p{
            color: #3498db;
        }
        
        h1 {
            font-family: 'Alegreya', serif;
            font-weight: 700;
            color: #ffffff;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upload-section {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .upload-section h2 {
            font-family: 'Alegreya', serif;
            font-weight: 700;
            margin-top: 0;
            color: #2ecc71;
        }
        
        .file-input-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .file-input-container label {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-input-container label:hover {
            background-color: #2980b9;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-name {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .control-section {
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
            min-width: 200px;
        }
        
        button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #27ae60;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        /* Clickable row styles */
        tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        tbody tr:hover {
            background-color: #e8f4f8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        tbody tr:active {
            background-color: #d4edda;
        }
        
        .result-section {
            text-align: center;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }
        
        .chosen-book {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }
        
        .book-details {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .book-isbn {
            font-size: 18px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        .book-cover {
            max-width: 150px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        .search-links {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .search-link {
            background-color: #3498db;
            color: white;
            padding: 8px 12px;
            text-decoration: none;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        
        .search-link:hover {
            background-color: #2980b9;
        }
        
        .search-link img {
            height: 16px;
            margin-right: 5px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .isbn-loading {
            display: inline-block;
            font-size: 16px;
            color: #7f8c8d;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .pagination button {
            margin: 0 5px;
            background-color: #3498db;
        }
        
        .pagination button.active {
            background-color: #2c3e50;
        }
        
        .info-text {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 20px;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
            display: none;
        }

        .intro-section {
     background-color: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
    line-height: 1.5;
}

.intro-section p {
    margin-bottom: 15px;
}

.intro-section ul {
    margin-left: 20px;
    margin-bottom: 15px;
}

.intro-section code {
    background-color: #f5f5f5;
    padding: 2px 5px;
    border-radius: 3px;
}

        /* Click hint text */
        .click-hint {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>New Book Purchase Decision Maker</h1>

    <div class="intro-section">
        <p>Welcome to Book Selector! This tool helps you randomly choose a book to read from your collection.</p>
        <p><strong>How to use:</strong></p>
        <ul>
            <li>A default book list is loaded automatically</li>
            <li>Filter by genre using the dropdown menu</li>
            <li>Click "Choose a book!" to get a random selection</li>
            <li><strong>Click on any book title in the table to see its details</strong></li>
        </ul>
        <p><strong>To upload your own book list:</strong></p>
        <ul>
            <li>Create a CSV or Excel file with at least two columns: <code>TITLE</code> and <code>GENRE</code></li>
            <li>Optional: Add an <code>ISBN</code> column for direct book lookup</li>
            <li>Upload your file using the section below</li>
        </ul>
    </div>
    
    <div class="upload-section">
        <h2>Upload Your Book List</h2>
        <div class="file-input-container">
            <label for="fileInput">Choose CSV or Excel File</label>
            <input type="file" id="fileInput" accept=".csv, .xlsx, .xls">
            <span class="file-name" id="fileName">No file selected</span>
        </div>
        <p class="info-text">Default list is loaded automatically, or upload your own CSV/Excel file with TITLE and GENRE columns.</p>
    </div>
    
    <div class="control-section">
        <label for="genreSelect">Genre choice:</label>
        <select id="genreSelect">
            <option value="all">All Genres</option>
        </select>
        <button id="chooseBookBtn" disabled>Choose a book!</button>
    </div>
    
    <div id="tableContainer">
        <div id="loadingIndicator">
            <span class="loading"></span> Loading books...
        </div>
        <div class="click-hint hidden" id="clickHint">ðŸ’¡ Click on any book title to see its details</div>
        <table id="booksTable" class="hidden">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Genre</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
        <p id="tableInfo" class="info-text"></p>
    </div>
    
    <div class="result-section hidden" id="resultSection">
        <h2>Book Details</h2>
        <div class="chosen-book" id="chosenBook"></div>
        <div class="book-details">
            <div id="isbnLoading" class="isbn-loading hidden">
                <span class="loading"></span> Looking up book details...
            </div>
            <div id="bookInfo" class="hidden">
                <div class="book-isbn" id="bookIsbn"></div>
                <img id="bookCover" class="book-cover hidden" src="" alt="Book cover">
                <div class="search-links" id="searchLinks"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let booksData = [];
        let filteredBooks = [];
        const itemsPerPage = 10;
        let currentPage = 1;
        
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const genreSelect = document.getElementById('genreSelect');
        const chooseBookBtn = document.getElementById('chooseBookBtn');
        const booksTable = document.getElementById('booksTable');
        const tableBody = document.getElementById('tableBody');
        const resultSection = document.getElementById('resultSection');
        const chosenBook = document.getElementById('chosenBook');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const pagination = document.getElementById('pagination');
        const tableInfo = document.getElementById('tableInfo');
        const isbnLoading = document.getElementById('isbnLoading');
        const bookInfo = document.getElementById('bookInfo');
        const bookIsbn = document.getElementById('bookIsbn');
        const bookCover = document.getElementById('bookCover');
        const searchLinks = document.getElementById('searchLinks');
        const clickHint = document.getElementById('clickHint');

        // Array of image URLs
        const imageUrls = [
            "https://images.unsplash.com/photo-1591951425328-48c1fe7179cd?q=80&w=3270&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
            "https://images.unsplash.com/photo-1591951425600-d09958978584?q=80&w=3270&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
            "https://images.unsplash.com/photo-1597105026857-eda9652f9e49?q=80&w=2508&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
            "https://images.unsplash.com/photo-1588287028941-99e3c7601d0e?q=80&w=3086&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
            "https://images.unsplash.com/photo-1587811798408-e7200ed808d0?q=80&w=3253&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
            "https://images.unsplash.com/photo-1595405895473-1adb3f68501a?q=80&w=2500&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
            "https://images.unsplash.com/photo-1604967941346-f1b8097cf97e?q=80&w=2450&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
             "https://images.unsplash.com/photo-1610116306796-6fea9f4fae38?q=80&w=3270&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"

        ];

        // Function to set random background
        function setRandomBackground() {
            const randomIndex = Math.floor(Math.random() * imageUrls.length);
            const selectedImage = imageUrls[randomIndex];
            document.body.style.backgroundImage = `url('${selectedImage}')`;
        }

        // Set initial random background when page loads
        window.addEventListener('load', setRandomBackground);
        
        // Function to parse CSV string to JSON
        function parseCSV(csvStr) {
            // First, check if the CSV contains quoted fields with commas
            const hasQuotedFields = csvStr.includes('"');
            
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            
            // Simple parser for CSV without quoted fields
            if (!hasQuotedFields) {
                const rowsSimple = csvStr.trim().split('\n');
                for (let i = 0; i < rowsSimple.length; i++) {
                    rows.push(rowsSimple[i].split(',').map(field => field.trim()));
                }
            } else {
                // Advanced parser for CSV with quoted fields
                for (let i = 0; i < csvStr.length; i++) {
                    const char = csvStr[i];
                    
                    if (char === '"') {
                        if (i + 1 < csvStr.length && csvStr[i + 1] === '"') {
                            // Double quotes inside quoted field
                            currentField += '"';
                            i++; // Skip the next quote
                        } else {
                            // Toggle quote state
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // End of field
                        currentRow.push(currentField.trim());
                        currentField = '';
                    } else if ((char === '\n' || char === '\r') && !inQuotes) {
                        // End of row
                        if (char === '\r' && i + 1 < csvStr.length && csvStr[i + 1] === '\n') {
                            i++; // Skip the next \n in \r\n
                        }
                        
                        // Don't add the field if it's the end of the line and the field is empty
                        if (currentField !== '') {
                            currentRow.push(currentField.trim());
                            currentField = '';
                        }
                        
                        // Only add non-empty rows
                        if (currentRow.length > 0) {
                            rows.push(currentRow);
                            currentRow = [];
                        }
                    } else {
                        // Regular character
                        currentField += char;
                    }
                }
                
                // Add the last field and row if needed
                if (currentField !== '') {
                    currentRow.push(currentField.trim());
                }
                if (currentRow.length > 0) {
                    rows.push(currentRow);
                }
            }
            
            return rows;
        }
        
        // Function to load CSV from URL
        async function loadDefaultCSV() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/Connor-Sebastian-S/new-book-decision/refs/heads/main/books.csv');
                const data = await response.text();
                processCSV(data);
            } catch (error) {
                console.error('Error loading default CSV:', error);
                alert('Failed to load the default book list. Please try uploading your own file.');
            }
        }
        
        // Process CSV data
        function processCSV(data) {
            const rows = parseCSV(data);
            
            // Ensure we have at least a header row
            if (rows.length === 0) {
                alert('CSV file appears to be empty');
                return;
            }
            
            const headers = rows[0].map(header => header.trim().toUpperCase());
            
            // Validate that required columns exist
            const titleIndex = headers.indexOf('TITLE');
            const genreIndex = headers.indexOf('GENRE');
            
            if (titleIndex === -1 || genreIndex === -1) {
                alert(`CSV file must contain TITLE and GENRE columns. Found columns: ${headers.join(', ')}`);
                return;
            }
            
            // Check for ISBN column
            const isbnIndex = headers.indexOf('ISBN');
            
            booksData = [];
            
            // Start from index 1 to skip header row
            for (let i = 1; i < rows.length; i++) {
                const currentRow = rows[i];
                
                // Skip rows that don't have enough columns
                if (currentRow.length <= Math.max(titleIndex, genreIndex)) continue;
                
                const title = currentRow[titleIndex];
                const genre = currentRow[genreIndex];
                
                // Get ISBN if available
                let isbn = null;
                if (isbnIndex !== -1 && currentRow.length > isbnIndex) {
                    isbn = currentRow[isbnIndex];
                }
                
                if (title && genre) {
                    booksData.push({ title, genre, isbn });
                }
            }
            
            console.log(`Successfully parsed ${booksData.length} books`);
            
            populateGenreDropdown();
            filterBooks();
            booksTable.classList.remove('hidden');
            clickHint.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
        }
        
        // Process Excel files
        function processExcel(data) {
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Validate that we have data
            if (!jsonData.length) {
                alert('Excel file appears to be empty');
                return;
            }
            
            const headers = jsonData[0].map(header => String(header).trim().toUpperCase());
            
            // Validate that required columns exist
            const titleIndex = headers.indexOf('TITLE');
            const genreIndex = headers.indexOf('GENRE');
            
            if (titleIndex === -1 || genreIndex === -1) {
                alert(`Excel file must contain TITLE and GENRE columns. Found columns: ${headers.join(', ')}`);
                return;
            }
            
            // Check for ISBN column
            const isbnIndex = headers.indexOf('ISBN');
            
            booksData = [];
            
            // Start from index 1 to skip header row
            for (let i = 1; i < jsonData.length; i++) {
                const currentRow = jsonData[i];
                
                // Skip rows that don't have enough columns
                if (!currentRow || currentRow.length <= Math.max(titleIndex, genreIndex)) continue;
                
                const title = String(currentRow[titleIndex] || '').trim();
                const genre = String(currentRow[genreIndex] || '').trim();
                
                // Get ISBN if available
                let isbn = null;
                if (isbnIndex !== -1 && currentRow.length > isbnIndex) {
                    isbn = String(currentRow[isbnIndex] || '').trim();
                }
                
                if (title && genre) {
                    booksData.push({ title, genre, isbn });
                }
            }
            
            populateGenreDropdown();
            filterBooks();
            booksTable.classList.remove('hidden');
            clickHint.classList.remove('hidden');
            loadingIndicator.classList.add('hidden');
        }
        
        // Populate genre dropdown
        function populateGenreDropdown() {
            // Clear existing options except "All Genres"
            while (genreSelect.options.length > 1) {
                genreSelect.remove(1);
            }
            
            // Get unique genres
            const genres = [...new Set(booksData.map(book => book.genre))].sort();
            
            // Add genre options
            genres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreSelect.appendChild(option);
            });
            
            // Enable choose button if we have data
            chooseBookBtn.disabled = booksData.length === 0;
        }
        
        // Filter books by selected genre
        function filterBooks() {
            const selectedGenre = genreSelect.value;
            
            if (selectedGenre === 'all') {
                filteredBooks = [...booksData];
            } else {
                filteredBooks = booksData.filter(book => book.genre === selectedGenre);
            }
            
            currentPage = 1;
            displayBooks();
            updatePagination();
            
            // Update info text
            tableInfo.textContent = `Showing ${filteredBooks.length} books${selectedGenre !== 'all' ? ` in the "${selectedGenre}" genre` : ''} out of ${booksData.length} total books`;
        }
        
        // Display books in table
        function displayBooks() {
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Calculate start and end indices for current page
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredBooks.length);
            
            // Create table rows
            for (let i = startIndex; i < endIndex; i++) {
                const book = filteredBooks[i];
                const row = document.createElement('tr');
                
                // Add click event to the row
                row.addEventListener('click', () => {
                    showBookDetails(book);
                });
                
                const titleCell = document.createElement('td');
                titleCell.textContent = book.title;
                row.appendChild(titleCell);
                
                const genreCell = document.createElement('td');
                genreCell.textContent = book.genre;
                row.appendChild(genreCell);
                
                tableBody.appendChild(row);
            }
        }
        
        // Show book details (used by both random selection and clicking)
        function showBookDetails(book) {
            chosenBook.textContent = book.title;
            resultSection.classList.remove('hidden');
            
            // Reset book info
            bookInfo.classList.add('hidden');
            bookCover.classList.add('hidden');
            searchLinks.innerHTML = '';
            
            // Show loading indicator
            isbnLoading.classList.remove('hidden');
            
            // If we already have ISBN, use it
            if (book.isbn) {
                displayBookInfo(book.title, book.isbn);
            } else {
                // Otherwise, look it up
                lookupISBN(book.title);
            }
            
            // Scroll to result section
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Update pagination controls
        function updatePagination() {
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(filteredBooks.length / itemsPerPage);
            
            if (totalPages <= 1) {
                return;
            }
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'â†';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayBooks();
                    updatePagination();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust startPage if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    displayBooks();
                    updatePagination();
                });
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'â†’';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayBooks();
                    updatePagination();
                }
            });
            pagination.appendChild(nextBtn);
        }
        
        // Choose a random book
        function chooseRandomBook() {
            if (filteredBooks.length === 0) {
                alert('No books available in the selected genre');
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * filteredBooks.length);
            const randomBook = filteredBooks[randomIndex];
            
            showBookDetails(randomBook);
        }
        
        // Display book info
        function displayBookInfo(title, isbn) {
            // Hide loading indicator
            isbnLoading.classList.add('hidden');
            
            // Show book info
            bookInfo.classList.remove('hidden');
            
            // Display ISBN
            bookIsbn.textContent = `ISBN: ${isbn}`;
            
            // Try to get book cover
            const coverUrl = `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg`;
            bookCover.src = coverUrl;
            bookCover.onload = function() {
                if (this.naturalWidth > 1) {
                    //bookCover.